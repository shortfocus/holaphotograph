---
import Layout from '../layouts/Layout.astro';
---

<Layout title="고객 후기 상세 - 올라포토" headerOpaque>
  <Fragment slot="head">
    <script src="https://unpkg.com/dompurify@3.0.9/dist/purify.min.js"></script>
  </Fragment>
  <article class="mx-auto max-w-3xl px-4 pt-[calc(5.5rem+env(safe-area-inset-top,0px))] pb-8 sm:px-6 sm:pt-24 sm:pb-12">
    <div id="post-loading" class="py-16 text-center text-gray-500">로딩 중...</div>
    <div id="post-content" class="hidden">
      <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
        <header class="border-b border-gray-200 px-6 py-6 sm:px-8 sm:py-8">
          <h1 id="post-title" class="text-2xl font-bold sm:text-3xl"></h1>
          <p id="post-date" class="mt-2 text-sm text-gray-500"></p>
        </header>
        <div class="px-6 py-6 sm:px-8 sm:py-8">
          <div id="post-thumbnail" class="mb-6 hidden">
            <img id="post-thumb-img" src="" alt="" class="w-full aspect-video rounded-lg object-cover" />
          </div>
          <div id="post-body" class="post-body"></div>
          <div id="post-youtube" class="mt-6 hidden">
            <a id="post-youtube-link" href="#" target="_blank" rel="noopener" class="inline-flex items-center gap-2 rounded-lg bg-red-600 px-6 py-3 font-medium text-white hover:bg-red-700">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
              </svg>
              유튜브에서 보기
            </a>
          </div>
        </div>
      </div>
      <div class="mt-6">
        <a href="/reviews" class="text-gray-600 hover:text-gray-900">← 고객 후기 목록으로</a>
      </div>
    </div>
    <div id="post-error" class="hidden py-16 text-center">
      <p class="text-red-600">후기를 찾을 수 없습니다.</p>
      <a href="/reviews" class="mt-4 inline-block text-blue-600 hover:underline">고객 후기 목록으로</a>
    </div>
  </article>
</Layout>

<script>
  import { fetchPost } from '../lib/api';

  const params = new URLSearchParams(window.location.search);
  const id = parseInt(params.get('id') || '0', 10);

  const loadingEl = document.getElementById('post-loading')!;
  const contentEl = document.getElementById('post-content')!;
  const errorEl = document.getElementById('post-error')!;

  async function load() {
    if (!id) {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      return;
    }

    try {
      const post = await fetchPost(id);
      if (!post) {
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        return;
      }

      loadingEl.classList.add('hidden');
      contentEl.classList.remove('hidden');

      (document.getElementById('post-title') as HTMLElement).textContent = post.title;
      (document.getElementById('post-date') as HTMLElement).textContent = new Date(post.created_at).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });

      const thumbEl = document.getElementById('post-thumbnail')!;
      const thumbImg = document.getElementById('post-thumb-img') as HTMLImageElement;
      if (post.thumbnail_url) {
        thumbImg.src = post.thumbnail_url;
        thumbImg.alt = post.title;
        thumbEl.classList.remove('hidden');
      } else {
        thumbEl.classList.add('hidden');
      }

      const bodyEl = document.getElementById('post-body')!;
      if (post.content) {
        const isHtml = post.content.trim().startsWith('<');
        const raw = isHtml ? post.content : post.content.replace(/\n/g, '<br />');
        const DOMPurify = (window as Window & { DOMPurify?: { sanitize: (d: string, o?: object) => string } }).DOMPurify;
        bodyEl.innerHTML = DOMPurify ? DOMPurify.sanitize(raw, { ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'blockquote', 'pre', 'code', 'img', 'figure', 'figcaption'], ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'width', 'height', 'class'], ADD_DATA_URI_TAGS: ['img'] }) : raw;
        bodyEl.classList.remove('hidden');
      } else {
        bodyEl.classList.add('hidden');
      }

      const youtubeEl = document.getElementById('post-youtube')!;
      youtubeEl.classList.add('hidden');

      document.title = `${post.title} - 고객 후기`;
    } catch (e) {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
    }
  }

  load();
</script>
