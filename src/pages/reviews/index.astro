---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="고객 후기 - 올라포토" headerOpaque>
  <Fragment slot="head">
    <link rel="stylesheet" href="https://unpkg.com/trix@2.0.8/dist/trix.css" />
    <script src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.9/dist/purify.min.js"></script>
    <style is:global>
      .padlet-board {
        background: #fff;
        min-height: 100vh;
        position: relative;
      }
      .padlet-banner {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        font-size: 1.125rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      .postit-note {
        box-shadow: 2px 4px 12px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.08);
      }
      .postit-note:hover {
        box-shadow: 3px 6px 18px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.1);
      }
      .reviews-board .trix-content { background: transparent !important; border: 1px solid #d6d3d1 !important; }
      .reviews-board .trix-content:focus-within { border-color: #a8a29e !important; outline: none; }
      .reviews-modal-backdrop { background: rgba(0,0,0,0.5); }
      .reviews-modal-content { max-height: 85vh; overflow: auto; }
      .reviews-tab { font-weight: 600; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; border-bottom: 2px solid transparent; margin-bottom: -1px; }
      /* inactive: 그레이로 구분 */
      .reviews-tab[aria-selected="false"] { background: #e5e7eb; color: #6b7280; }
      .reviews-tab[aria-selected="false"]:hover { background: #d1d5db; color: #4b5563; }
      /* active: 스카이블루 + 세이지 파스텔 */
      .reviews-tab-snap[aria-selected="true"] { background: #7dd3fc; color: #1e3a8a; }
      .reviews-tab-lecture[aria-selected="true"] { background: #34d399; color: #064e3b; }
      /* inactive 탭: 하단 보더만 활성 탭 색상 */
      .reviews-tablist--snap .reviews-tab { border-bottom-color: #0284c7; }
      .reviews-tablist--lecture .reviews-tab { border-bottom-color: #059669; }
      /* active 탭: 하단 보더 제거, 좌·상·우만 활성 색상 + 보더 색상 shadow */
      .reviews-tablist--snap .reviews-tab-snap[aria-selected="true"] { border-left: 2px solid #0284c7; border-top: 2px solid #0284c7; border-right: 2px solid #0284c7; border-bottom-color: transparent; box-shadow: 0 0 14px rgba(2, 132, 199, 0.45); }
      .reviews-tablist--lecture .reviews-tab-lecture[aria-selected="true"] { border-left: 2px solid #059669; border-top: 2px solid #059669; border-right: 2px solid #059669; border-bottom-color: transparent; box-shadow: 0 0 14px rgba(5, 150, 105, 0.45); }
      .reviews-tablist { border-bottom: 1px solid #e5e7eb; }
      /* 패널: 노출 중일 때 좌·하·우 보더를 해당 탭 색상으로 + 보더 색상 shadow */
      .reviews-panel-snap:not(.hidden) { border-left: 2px solid #0284c7; border-right: 2px solid #0284c7; border-bottom: 2px solid #0284c7; border-top: none; box-shadow: 0 4px 18px rgba(2, 132, 199, 0.35); }
      .reviews-panel-lecture:not(.hidden) { border-left: 2px solid #059669; border-right: 2px solid #059669; border-bottom: 2px solid #059669; border-top: none; box-shadow: 0 4px 18px rgba(5, 150, 105, 0.35); }
      /* 고객 후기 등록 접기: 기존 카드와 동일 크기, 점선 + 중앙 + 버튼 */
      .review-add-card {
        min-height: 12rem;
        height: 100%;
        border: 2px dashed #94a3b8;
        border-radius: 0.125rem;
        background: #fafaf9;
        box-shadow: 2px 4px 12px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
      }
      .review-add-card:hover { background: #f5f5f4; border-color: #64748b; box-shadow: 3px 6px 18px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.1); }
      .review-add-card .review-add-btn {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background: #e7e5e4;
        color: #57534e;
        font-size: 1.5rem;
        line-height: 1;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
      }
      .review-add-card:hover .review-add-btn { background: #d6d3d1; color: #44403c; }
    </style>
  </Fragment>
  <div class="padlet-board px-4 pt-[calc(5.5rem+env(safe-area-inset-top,0px))] pb-16 sm:px-6 sm:pt-28 sm:pb-20 reviews-board">
    <div class="relative mx-auto max-w-6xl">
      <!-- 탭: 스냅 촬영 후기 | 강의 수강 후기 -->
      <div id="reviews-tablist" class="reviews-tablist reviews-tablist--snap flex overflow-hidden rounded-t-lg bg-stone-200 shadow sm:mb-0" role="tablist">
        <button type="button" id="tab-snap" class="reviews-tab reviews-tab-snap flex-1 rounded-tl-lg px-4 py-3 text-center text-sm sm:py-3.5 sm:text-base" role="tab" aria-selected="true" aria-controls="panel-snap" data-tab="snap">스냅 촬영 후기</button>
        <button type="button" id="tab-lecture" class="reviews-tab reviews-tab-lecture flex-1 rounded-tr-lg px-4 py-3 text-center text-sm sm:py-3.5 sm:text-base" role="tab" aria-selected="false" aria-controls="panel-lecture" data-tab="lecture">강의 수강 후기</button>
      </div>

      <!-- 탭 1: 스냅 촬영 후기 — 전체 4×3 그리드, 1번 칸=등록, 2~12번=후기 카드 -->
      <div id="panel-snap" class="reviews-panel-snap rounded-b-lg bg-white px-4 py-6 shadow sm:px-6 sm:py-8" role="tabpanel" aria-labelledby="tab-snap">
        <p class="mb-6 text-sm font-bold text-stone-600">작성하신 후기는 관리자 검토 후 보드에 게시됩니다.</p>
        <section id="reviews-section-snap" class="relative grid min-h-[20rem] grid-cols-2 gap-4 sm:grid-cols-4 sm:gap-5 grid-rows-3">
          <div class="relative z-10 min-w-0">
            <div id="add-card-snap" class="review-add-card" role="button" tabindex="0" aria-label="고객 후기 등록">
              <span class="review-add-btn" aria-hidden="true">➕</span>
            </div>
          </div>
          <div id="reviews-empty-snap" class="pointer-events-none absolute inset-0 hidden flex items-center justify-center text-center" aria-hidden="true">
            <p class="text-stone-500">아직 게시된 후기가 없습니다.<br />➕ 버튼을 눌러 후기를 남겨보세요!</p>
          </div>
        </section>
      </div>

      <!-- 탭 2: 강의 수강 후기 — 전체 4×3 그리드, 1번 칸=등록, 2~12번=후기 카드 -->
      <div id="panel-lecture" class="reviews-panel-lecture hidden rounded-b-lg bg-white px-4 py-6 shadow sm:px-6 sm:py-8" role="tabpanel" aria-labelledby="tab-lecture">
        <p class="mb-6 text-sm font-bold text-stone-600">작성하신 후기는 관리자 검토 후 보드에 게시됩니다.</p>
        <section id="reviews-section-lecture" class="relative grid min-h-[20rem] grid-cols-2 gap-4 sm:grid-cols-4 sm:gap-5 grid-rows-3">
          <div class="relative z-10 min-w-0">
            <div id="add-card-lecture" class="review-add-card" role="button" tabindex="0" aria-label="고객 후기 등록">
              <span class="review-add-btn" aria-hidden="true">➕</span>
            </div>
          </div>
          <div id="reviews-empty" class="pointer-events-none absolute inset-0 hidden flex items-center justify-center text-center" aria-hidden="true">
            <p class="text-stone-500">아직 게시된 후기가 없습니다.<br />➕ 버튼을 눌러 후기를 남겨보세요!</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- 후기 전체 내용 모달 (상세 페이지 대체) -->
  <div id="review-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 reviews-modal-backdrop" aria-hidden="true">
    <div class="postit-note reviews-modal-content w-full max-w-lg rounded-lg bg-white p-6 shadow-xl" role="dialog" aria-labelledby="review-modal-title">
      <div class="mb-4 flex items-start justify-between gap-4">
        <h2 id="review-modal-title" class="text-xl font-bold text-stone-800"></h2>
        <button type="button" id="review-modal-close" class="shrink-0 rounded p-1 text-stone-400 hover:bg-stone-100 hover:text-stone-600" aria-label="닫기">✕</button>
      </div>
      <p id="review-modal-meta" class="mb-4 text-sm text-stone-500"></p>
      <div id="review-modal-body" class="post-body text-stone-700 prose prose-sm max-w-none prose-img:rounded-lg"></div>
    </div>
  </div>

  <!-- 고객 후기 등록 모달 -->
  <div id="review-register-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 reviews-modal-backdrop" aria-hidden="true" aria-labelledby="review-register-modal-title">
    <div class="reviews-modal-content w-full max-w-lg rounded-lg bg-white p-6 shadow-xl" role="dialog">
      <div class="mb-4 flex items-center justify-between">
        <h2 id="review-register-modal-title" class="text-lg font-bold text-stone-800">고객 후기 등록</h2>
        <button type="button" id="review-register-modal-close" class="shrink-0 rounded p-1 text-stone-400 hover:bg-stone-100 hover:text-stone-600" aria-label="닫기">✕</button>
      </div>
      <form id="review-form-modal" class="space-y-3">
        <div>
          <label for="review-author-modal" class="block text-xs font-semibold text-stone-700">성함 / 닉네임 <span class="text-red-500">*</span></label>
          <input type="text" id="review-author-modal" name="author_name" required maxlength="100" placeholder="이름 입력"
            class="mt-0.5 w-full rounded border border-stone-300 bg-stone-50/50 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" />
        </div>
        <div>
          <label for="review-title-modal" class="block text-xs font-semibold text-stone-700">제목 <span class="text-red-500">*</span></label>
          <input type="text" id="review-title-modal" name="title" required maxlength="500" placeholder="제목 입력"
            class="mt-0.5 w-full rounded border border-stone-300 bg-stone-50/50 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" />
        </div>
        <div>
          <label for="review-content-modal" class="block text-xs font-semibold text-stone-700">내용 <span class="text-red-500">*</span></label>
          <input id="review-content-modal" name="content" type="hidden" required />
          <trix-editor input="review-content-modal" class="trix-content mt-0.5 min-h-35 rounded border border-stone-300 bg-stone-50/30 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" placeholder="후기 내용"></trix-editor>
        </div>
        <div id="review-form-message-modal" class="hidden text-xs"></div>
        <div class="flex gap-2 pt-1">
          <button type="submit" id="review-submit-modal" class="cursor-pointer rounded bg-stone-800 px-4 py-2 text-sm font-medium text-white hover:bg-stone-700 disabled:opacity-50">등록</button>
          <button type="reset" id="review-reset-modal" class="cursor-pointer rounded border border-stone-200 bg-white px-4 py-2 text-sm font-medium text-stone-700 hover:bg-stone-50">비우기</button>
          <button type="button" id="review-register-cancel" class="cursor-pointer rounded border border-stone-200 bg-white px-4 py-2 text-sm font-medium text-stone-700 hover:bg-stone-50">닫기</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 등록 결과 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 reviews-modal-backdrop" aria-hidden="true">
    <div class="w-full max-w-sm rounded-lg bg-white p-6 shadow-xl" role="dialog" aria-labelledby="alert-modal-title">
      <h2 id="alert-modal-title" class="text-lg font-bold text-stone-800"></h2>
      <p id="alert-modal-message" class="mt-2 text-sm text-stone-600"></p>
      <div class="mt-6 flex justify-end">
        <button type="button" id="alert-modal-close" class="cursor-pointer rounded-md bg-stone-800 px-4 py-2 text-sm font-medium text-white hover:bg-stone-700">확인</button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { fetchApprovedReviews, submitReview, uploadReviewImage, type Post } from '../../lib/api';

  const sectionSnap = document.getElementById('reviews-section-snap')!;
  const sectionLecture = document.getElementById('reviews-section-lecture')!;
  const emptyEl = document.getElementById('reviews-empty')!;
  const emptySnap = document.getElementById('reviews-empty-snap')!;
  const modal = document.getElementById('review-modal')!;
  const registerModal = document.getElementById('review-register-modal')!;
  const registerModalClose = document.getElementById('review-register-modal-close')!;
  const registerModalTitle = document.getElementById('review-register-modal-title')!;
  const formModal = document.getElementById('review-form-modal') as HTMLFormElement;
  const contentInputModal = document.getElementById('review-content-modal') as HTMLInputElement;
  const formMessageModal = document.getElementById('review-form-message-modal')!;
  const submitBtnModal = document.getElementById('review-submit-modal')!;
  const modalTitle = document.getElementById('review-modal-title')!;
  const modalMeta = document.getElementById('review-modal-meta')!;
  const modalBody = document.getElementById('review-modal-body')!;
  const modalClose = document.getElementById('review-modal-close')!;
  const tabSnap = document.getElementById('tab-snap')!;
  const tabLecture = document.getElementById('tab-lecture')!;
  const panelSnap = document.getElementById('panel-snap')!;
  const panelLecture = document.getElementById('panel-lecture')!;

  const tablist = document.getElementById('reviews-tablist')!;
  tabSnap.addEventListener('click', () => {
    tabSnap.setAttribute('aria-selected', 'true');
    tabLecture.setAttribute('aria-selected', 'false');
    panelSnap.classList.remove('hidden');
    panelLecture.classList.add('hidden');
    tablist.classList.remove('reviews-tablist--lecture');
    tablist.classList.add('reviews-tablist--snap');
  });
  tabLecture.addEventListener('click', () => {
    tabLecture.setAttribute('aria-selected', 'true');
    tabSnap.setAttribute('aria-selected', 'false');
    panelLecture.classList.remove('hidden');
    panelSnap.classList.add('hidden');
    tablist.classList.remove('reviews-tablist--snap');
    tablist.classList.add('reviews-tablist--lecture');
  });

  const addCardSnap = document.getElementById('add-card-snap')!;
  const addCardLecture = document.getElementById('add-card-lecture')!;
  let currentRegisterType: 'snap' | 'lecture' = 'snap';

  function openRegisterModal(type: 'snap' | 'lecture') {
    currentRegisterType = type;
    registerModalTitle.textContent = type === 'snap' ? '스냅 촬영 후기 등록' : '강의 수강 후기 등록';
    registerModal.classList.remove('hidden');
    registerModal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeRegisterModal() {
    registerModal.classList.add('hidden');
    registerModal.classList.remove('flex');
    document.body.style.overflow = '';
    formModal?.reset();
    const trixEditor = formModal?.querySelector('trix-editor') as HTMLInputElement & { editor?: { loadHTML: (html: string) => void } };
    if (trixEditor?.editor) trixEditor.editor.loadHTML('');
  }

  addCardSnap.addEventListener('click', () => openRegisterModal('snap'));
  addCardSnap.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openRegisterModal('snap'); } });
  addCardLecture.addEventListener('click', () => openRegisterModal('lecture'));
  addCardLecture.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openRegisterModal('lecture'); } });

  registerModalClose.addEventListener('click', closeRegisterModal);
  document.getElementById('review-register-cancel')?.addEventListener('click', closeRegisterModal);
  registerModal.addEventListener('click', (e) => { if (e.target === registerModal) closeRegisterModal(); });

  function stripHtml(html: string): string {
    const div = document.createElement('div');
    div.innerHTML = html;
    return (div.textContent || div.innerText || '').trim();
  }

  function escapeHtml(s: string) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  /** 성함/닉네임 마스킹: 첫 글자만 보이고 나머지는 * (예: 김철수 → 김**, 동그라미 → 동***) */
  function maskAuthorName(name: string | null | undefined): string {
    if (!name || !name.trim()) return '';
    const t = name.trim();
    if (t.length === 1) return t;
    return t[0] + '*'.repeat(t.length - 1);
  }

  const POSTIT_COLORS = ['bg-amber-50', 'bg-rose-50', 'bg-sky-50', 'bg-emerald-50'];
  const POSTIT_ROTATIONS = ['-rotate-1', 'rotate-1', '-rotate-2', 'rotate-2'];

  function openReviewModal(post: Post) {
    const sanitize = (window as unknown as { DOMPurify?: { sanitize: (html: string) => string } }).DOMPurify?.sanitize;
    modalTitle.textContent = post.title;
    modalMeta.textContent = [maskAuthorName(post.author_name), new Date(post.created_at).toLocaleDateString('ko-KR')].filter(Boolean).join(' · ');
    modalBody.innerHTML = sanitize ? sanitize(post.content || '') : post.content || '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeReviewModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  modalClose.addEventListener('click', closeReviewModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeReviewModal(); });

  const alertModal = document.getElementById('alert-modal')!;
  const alertModalTitle = document.getElementById('alert-modal-title')!;
  const alertModalMessage = document.getElementById('alert-modal-message')!;
  const alertModalClose = document.getElementById('alert-modal-close')!;

  function openAlertModal(title: string, message: string) {
    alertModalTitle.textContent = title;
    alertModalMessage.textContent = message;
    alertModal.classList.remove('hidden');
    alertModal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeAlertModal() {
    alertModal.classList.add('hidden');
    alertModal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  alertModalClose.addEventListener('click', closeAlertModal);
  alertModal.addEventListener('click', (e) => { if (e.target === alertModal) closeAlertModal(); });
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (!alertModal.classList.contains('hidden')) closeAlertModal();
    else if (!registerModal.classList.contains('hidden')) closeRegisterModal();
    else closeReviewModal();
  });

  const postsById = new Map<number, Post>();

  function renderPostCard(post: Post, index: number) {
    postsById.set(post.id, post);
    const desc = post.content ? stripHtml(post.content).slice(0, 80) + (stripHtml(post.content).length > 80 ? '...' : '') : '';
    const dateStr = new Date(post.created_at).toLocaleDateString('ko-KR');
    const color = POSTIT_COLORS[index % POSTIT_COLORS.length];
    const rotation = POSTIT_ROTATIONS[index % POSTIT_ROTATIONS.length];
    return `
      <article class="review-card postit-note flex h-full min-h-0 cursor-pointer flex-col rounded-sm p-4 transition-transform hover:rotate-0 ${color} ${rotation}" data-id="${post.id}">
        <h3 class="shrink-0 break-words text-lg font-bold line-clamp-2 text-stone-800">${escapeHtml(post.title)}</h3>
        ${post.author_name ? `<p class="mt-1 shrink-0 text-xs text-stone-500">${escapeHtml(maskAuthorName(post.author_name))}</p>` : ''}
        <div class="min-h-0 flex-1 py-2">
          <p class="line-clamp-2 w-full break-words text-sm text-stone-600">${escapeHtml(desc)}</p>
        </div>
        <p class="mt-auto shrink-0 border-t border-stone-200/60 pt-2 text-xs text-stone-400">${dateStr}</p>
      </article>
    `;
  }

  document.addEventListener('trix-attachment-add', async (e: Event) => {
    const attachment = (e as CustomEvent & { attachment: { file?: File; setAttributes: (a: { url: string }) => void; remove: () => void } }).attachment;
    if (!attachment.file) return;
    try {
      const result = await uploadReviewImage(attachment.file);
      attachment.setAttributes({ url: result.url });
    } catch (err) {
      console.error('이미지 업로드 실패:', err);
      attachment.remove();
      alert((err as Error).message || '이미지 업로드에 실패했습니다.');
    }
  });

  async function handleFormSubmit(
    authorElId: string,
    titleElId: string,
    contentEl: HTMLInputElement | null,
    messageEl: HTMLElement,
    btnEl: HTMLElement,
    formEl: HTMLFormElement | null,
    reviewType: 'snap' | 'lecture'
  ): Promise<boolean> {
    const authorName = (document.getElementById(authorElId) as HTMLInputElement)?.value?.trim() ?? '';
    const title = (document.getElementById(titleElId) as HTMLInputElement)?.value?.trim() ?? '';
    const content = contentEl?.value?.trim() ?? '';
    if (!authorName || !title || !content) return false;
    messageEl.classList.add('hidden');
    btnEl.setAttribute('disabled', 'disabled');
    try {
      const res = await submitReview({ title, content, author_name: authorName, review_type: reviewType });
      formEl?.reset();
      const trixEditor = formEl?.querySelector('trix-editor') as HTMLInputElement & { editor?: { loadHTML: (html: string) => void } };
      if (trixEditor?.editor) trixEditor.editor.loadHTML('');
      openAlertModal('후기 등록 완료', res.message ?? '등록되었습니다. 관리자 검토 후 보드에 게시됩니다.');
      return true;
    } catch (err) {
      openAlertModal('등록 실패', (err as Error).message);
      return false;
    } finally {
      btnEl.removeAttribute('disabled');
    }
  }

  formModal?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const ok = await handleFormSubmit('review-author-modal', 'review-title-modal', contentInputModal, formMessageModal, submitBtnModal, formModal, currentRegisterType);
    if (ok) {
      closeRegisterModal();
      load();
    }
  });

  document.getElementById('review-reset-modal')?.addEventListener('click', () => {
    const trixEditor = formModal?.querySelector('trix-editor') as HTMLInputElement & { editor?: { loadHTML: (html: string) => void } };
    if (trixEditor?.editor) trixEditor.editor.loadHTML('');
  });

  async function load() {
    try {
      const posts = await fetchApprovedReviews();
      const lecturePosts = posts.filter((p) => (p.review_type ?? 'lecture') === 'lecture');
      const snapPosts = posts.filter((p) => p.review_type === 'snap');
      emptyEl.classList.toggle('hidden', lecturePosts.length > 0);
      emptySnap.classList.toggle('hidden', snapPosts.length > 0);
      sectionSnap.querySelectorAll('.review-card').forEach((el) => el.remove());
      sectionLecture.querySelectorAll('.review-card').forEach((el) => el.remove());
      lecturePosts.forEach((p, i) => {
        const wrap = document.createElement('div');
        wrap.innerHTML = renderPostCard(p, i);
        const card = wrap.firstElementChild!;
        sectionLecture.appendChild(card);
      });
      snapPosts.forEach((p, i) => {
        const wrap = document.createElement('div');
        wrap.innerHTML = renderPostCard(p, i);
        const card = wrap.firstElementChild!;
        sectionSnap.appendChild(card);
      });
    } catch (e) {
      sectionSnap.querySelectorAll('.review-card').forEach((el) => el.remove());
      sectionLecture.querySelectorAll('.review-card').forEach((el) => el.remove());
      const errMsg = document.createElement('p');
      errMsg.className = 'col-span-2 sm:col-span-4 text-center text-red-600';
      errMsg.style.gridColumn = '1 / -1';
      errMsg.textContent = `고객 후기를 불러올 수 없습니다: ${(e as Error).message}`;
      sectionSnap.appendChild(errMsg);
      sectionLecture.appendChild(errMsg.cloneNode(true));
    }
  }

  function onSectionClick(e: Event) {
    const card = (e.target as HTMLElement).closest('article[data-id]');
    if (!card) return;
    const id = parseInt(card.getAttribute('data-id') || '0', 10);
    const post = postsById.get(id);
    if (post) openReviewModal(post);
  }

  sectionSnap.addEventListener('click', onSectionClick);
  sectionLecture.addEventListener('click', onSectionClick);

  load();
</script>
