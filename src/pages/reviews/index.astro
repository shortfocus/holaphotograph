---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="고객 후기 - 올라포토" headerOpaque>
  <Fragment slot="head">
    <link rel="stylesheet" href="https://unpkg.com/trix@2.0.8/dist/trix.css" />
    <script src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.9/dist/purify.min.js"></script>
    <style is:global>
      .padlet-board {
        background: #fff;
        min-height: 100vh;
        position: relative;
      }
      .padlet-banner {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        font-size: 1.125rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      .postit-note {
        box-shadow: 2px 4px 12px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.08);
      }
      .postit-note:hover {
        box-shadow: 3px 6px 18px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.1);
      }
      .reviews-board .trix-content { background: transparent !important; border: 1px solid #d6d3d1 !important; }
      .reviews-board .trix-content:focus-within { border-color: #a8a29e !important; outline: none; }
      .reviews-modal-backdrop { background: rgba(0,0,0,0.5); }
      .reviews-modal-content { max-height: 85vh; overflow: auto; }
    </style>
  </Fragment>
  <div class="padlet-board px-4 pt-[calc(5.5rem+env(safe-area-inset-top,0px))] pb-16 sm:px-6 sm:pt-28 sm:pb-20 reviews-board">
    <div class="relative mx-auto max-w-6xl">
      <!-- 패들릿 스타일 상단 배너 -->
      <div class="padlet-banner mb-6 rounded-b-lg sm:mb-8">
        고객 후기
      </div>
      <p class="mb-6 text-sm font-bold text-stone-600">작성하신 후기는 관리자 검토 후 보드에 게시됩니다.</p>

      <!-- 두 열: 고객 후기 등록 | 고객 후기 -->
      <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
        <!-- 왼쪽 열: 고객 후기 등록 -->
        <section>
          <h2 class="mb-4 text-xl font-bold text-stone-800">고객 후기 등록</h2>
          <div class="postit-note rounded-sm border border-stone-200 bg-white p-4 sm:min-h-80">
            <form id="review-form" class="space-y-3">
              <div>
                <label for="review-author" class="block text-xs font-semibold text-stone-700">성함 / 닉네임 <span class="text-red-500">*</span></label>
                <input type="text" id="review-author" name="author_name" required maxlength="100" placeholder="이름 입력"
                  class="mt-0.5 w-full rounded border border-stone-300 bg-stone-50/50 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" />
              </div>
              <div>
                <label for="review-title" class="block text-xs font-semibold text-stone-700">제목 <span class="text-red-500">*</span></label>
                <input type="text" id="review-title" name="title" required maxlength="500" placeholder="제목 입력"
                  class="mt-0.5 w-full rounded border border-stone-300 bg-stone-50/50 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" />
              </div>
              <div>
                <label for="review-content" class="block text-xs font-semibold text-stone-700">내용 <span class="text-red-500">*</span></label>
                <input id="review-content" name="content" type="hidden" required />
                <trix-editor input="review-content" class="trix-content mt-0.5 min-h-35 rounded border border-stone-300 bg-stone-50/30 px-2.5 py-1.5 text-sm text-stone-800 placeholder-stone-400 focus:border-stone-400 focus:outline-none focus:ring-1 focus:ring-stone-400" placeholder="후기 내용"></trix-editor>
              </div>
              <div id="review-form-message" class="hidden text-xs"></div>
              <div class="flex gap-2 pt-1">
                <button type="submit" id="review-submit" class="cursor-pointer rounded bg-stone-800 px-4 py-2 text-sm font-medium text-white hover:bg-stone-700 disabled:opacity-50">
                  등록
                </button>
                <button type="reset" id="review-reset" class="cursor-pointer rounded border border-stone-200 bg-white px-4 py-2 text-sm font-medium text-stone-700 hover:bg-stone-50">
                  비우기
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- 오른쪽 열: 고객 후기 목록 -->
        <section>
          <h2 class="mb-4 text-xl font-bold text-stone-800">고객 후기</h2>
          <div id="reviews-grid" class="grid grid-cols-1 gap-4 sm:grid-cols-2 sm:gap-5">
            <!-- 스켈레톤 -->
            <div class="postit-note animate-pulse rotate-1 rounded-sm bg-rose-50/80 p-4"><div class="space-y-2"><div class="h-4 rounded bg-rose-200/50 w-3/4" /><div class="h-3 rounded bg-rose-200/50 w-full" /><div class="h-3 rounded bg-rose-200/50 w-1/2" /></div></div>
            <div class="postit-note animate-pulse -rotate-2 rounded-sm bg-sky-50/80 p-4"><div class="space-y-2"><div class="h-4 rounded bg-sky-200/50 w-3/4" /><div class="h-3 rounded bg-sky-200/50 w-full" /><div class="h-3 rounded bg-sky-200/50 w-1/2" /></div></div>
          </div>
          <div id="reviews-empty" class="hidden pt-8 text-center">
            <p class="text-stone-500">아직 게시된 후기가 없습니다. 왼쪽에서 첫 후기를 남겨보세요.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- 후기 전체 내용 모달 (상세 페이지 대체) -->
  <div id="review-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 reviews-modal-backdrop" aria-hidden="true">
    <div class="postit-note reviews-modal-content w-full max-w-lg rounded-lg bg-white p-6 shadow-xl" role="dialog" aria-labelledby="review-modal-title">
      <div class="mb-4 flex items-start justify-between gap-4">
        <h2 id="review-modal-title" class="text-xl font-bold text-stone-800"></h2>
        <button type="button" id="review-modal-close" class="shrink-0 rounded p-1 text-stone-400 hover:bg-stone-100 hover:text-stone-600" aria-label="닫기">✕</button>
      </div>
      <p id="review-modal-meta" class="mb-4 text-sm text-stone-500"></p>
      <div id="review-modal-body" class="post-body text-stone-700 prose prose-sm max-w-none prose-img:rounded-lg"></div>
    </div>
  </div>

  <!-- 등록 결과 알림 모달 -->
  <div id="alert-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 reviews-modal-backdrop" aria-hidden="true">
    <div class="w-full max-w-sm rounded-lg bg-white p-6 shadow-xl" role="dialog" aria-labelledby="alert-modal-title">
      <h2 id="alert-modal-title" class="text-lg font-bold text-stone-800"></h2>
      <p id="alert-modal-message" class="mt-2 text-sm text-stone-600"></p>
      <div class="mt-6 flex justify-end">
        <button type="button" id="alert-modal-close" class="cursor-pointer rounded-md bg-stone-800 px-4 py-2 text-sm font-medium text-white hover:bg-stone-700">확인</button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { fetchApprovedReviews, submitReview, uploadReviewImage, type Post } from '../../lib/api';

  const grid = document.getElementById('reviews-grid')!;
  const emptyEl = document.getElementById('reviews-empty')!;
  const form = document.getElementById('review-form') as HTMLFormElement;
  const formMessage = document.getElementById('review-form-message')!;
  const submitBtn = document.getElementById('review-submit')!;
  const contentInput = document.getElementById('review-content') as HTMLInputElement;
  const modal = document.getElementById('review-modal')!;
  const modalTitle = document.getElementById('review-modal-title')!;
  const modalMeta = document.getElementById('review-modal-meta')!;
  const modalBody = document.getElementById('review-modal-body')!;
  const modalClose = document.getElementById('review-modal-close')!;

  function stripHtml(html: string): string {
    const div = document.createElement('div');
    div.innerHTML = html;
    return (div.textContent || div.innerText || '').trim();
  }

  function escapeHtml(s: string) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  const POSTIT_COLORS = ['bg-amber-50', 'bg-rose-50', 'bg-sky-50', 'bg-emerald-50'];
  const POSTIT_ROTATIONS = ['-rotate-1', 'rotate-1', '-rotate-2', 'rotate-2'];

  function openReviewModal(post: Post) {
    const sanitize = (window as unknown as { DOMPurify?: { sanitize: (html: string) => string } }).DOMPurify?.sanitize;
    modalTitle.textContent = post.title;
    modalMeta.textContent = [post.author_name, new Date(post.created_at).toLocaleDateString('ko-KR')].filter(Boolean).join(' · ');
    modalBody.innerHTML = sanitize ? sanitize(post.content || '') : post.content || '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeReviewModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  modalClose.addEventListener('click', closeReviewModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeReviewModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeReviewModal(); });

  const alertModal = document.getElementById('alert-modal')!;
  const alertModalTitle = document.getElementById('alert-modal-title')!;
  const alertModalMessage = document.getElementById('alert-modal-message')!;
  const alertModalClose = document.getElementById('alert-modal-close')!;

  function openAlertModal(title: string, message: string) {
    alertModalTitle.textContent = title;
    alertModalMessage.textContent = message;
    alertModal.classList.remove('hidden');
    alertModal.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeAlertModal() {
    alertModal.classList.add('hidden');
    alertModal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  alertModalClose.addEventListener('click', closeAlertModal);
  alertModal.addEventListener('click', (e) => { if (e.target === alertModal) closeAlertModal(); });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !alertModal.classList.contains('hidden')) closeAlertModal();
  });

  const postsById = new Map<number, Post>();

  function renderPostCard(post: Post, index: number) {
    postsById.set(post.id, post);
    const desc = post.content ? stripHtml(post.content).slice(0, 80) + (stripHtml(post.content).length > 80 ? '...' : '') : '';
    const dateStr = new Date(post.created_at).toLocaleDateString('ko-KR');
    const color = POSTIT_COLORS[index % POSTIT_COLORS.length];
    const rotation = POSTIT_ROTATIONS[index % POSTIT_ROTATIONS.length];
    return `
      <article class="postit-note flex h-full min-h-0 cursor-pointer flex-col rounded-sm p-4 transition-transform hover:rotate-0 ${color} ${rotation}" data-id="${post.id}">
        <h3 class="shrink-0 break-words text-lg font-bold line-clamp-2 text-stone-800">${escapeHtml(post.title)}</h3>
        ${post.author_name ? `<p class="mt-1 shrink-0 text-xs text-stone-500">${escapeHtml(post.author_name)}</p>` : ''}
        <div class="min-h-0 flex-1 py-2">
          <p class="line-clamp-2 w-full break-words text-sm text-stone-600">${escapeHtml(desc)}</p>
        </div>
        <p class="mt-auto shrink-0 border-t border-stone-200/60 pt-2 text-xs text-stone-400">${dateStr}</p>
      </article>
    `;
  }

  document.addEventListener('trix-attachment-add', async (e: Event) => {
    const attachment = (e as CustomEvent & { attachment: { file?: File; setAttributes: (a: { url: string }) => void; remove: () => void } }).attachment;
    if (!attachment.file) return;
    try {
      const result = await uploadReviewImage(attachment.file);
      attachment.setAttributes({ url: result.url });
    } catch (err) {
      console.error('이미지 업로드 실패:', err);
      attachment.remove();
      alert((err as Error).message || '이미지 업로드에 실패했습니다.');
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const authorName = (document.getElementById('review-author') as HTMLInputElement).value.trim();
    const title = (document.getElementById('review-title') as HTMLInputElement).value.trim();
    const content = contentInput?.value?.trim() ?? '';
    if (!authorName || !title || !content) return;
    formMessage.classList.add('hidden');
    submitBtn.setAttribute('disabled', 'disabled');
    try {
      const res = await submitReview({ title, content, author_name: authorName });
      form.reset();
      const trixEditor = form.querySelector('trix-editor') as HTMLInputElement & { editor?: { loadHTML: (html: string) => void } };
      if (trixEditor?.editor) trixEditor.editor.loadHTML('');
      openAlertModal('후기 등록 완료', res.message ?? '등록되었습니다. 관리자 검토 후 보드에 게시됩니다.');
    } catch (err) {
      openAlertModal('등록 실패', (err as Error).message);
    } finally {
      submitBtn.removeAttribute('disabled');
    }
  });

  document.getElementById('review-reset')?.addEventListener('click', () => {
    const trixEditor = form?.querySelector('trix-editor') as HTMLInputElement & { editor?: { loadHTML: (html: string) => void } };
    if (trixEditor?.editor) trixEditor.editor.loadHTML('');
  });

  async function load() {
    try {
      const posts = await fetchApprovedReviews();
      const skeletonCards = grid.querySelectorAll('.animate-pulse');
      skeletonCards.forEach((el) => el.remove());
      if (posts.length === 0) {
        emptyEl.classList.remove('hidden');
      } else {
        emptyEl.classList.add('hidden');
        posts.forEach((p, i) => {
          const wrap = document.createElement('div');
          wrap.innerHTML = renderPostCard(p, i);
          const card = wrap.firstElementChild!;
          grid.appendChild(card);
        });
      }
    } catch (e) {
      const skeletonCards = grid.querySelectorAll('.animate-pulse');
      skeletonCards.forEach((el) => el.remove());
      const errMsg = document.createElement('p');
      errMsg.className = 'col-span-full text-center text-red-600';
      errMsg.textContent = `고객 후기를 불러올 수 없습니다: ${(e as Error).message}`;
      grid.appendChild(errMsg);
    }
  }

  grid.addEventListener('click', (e) => {
    const card = (e.target as HTMLElement).closest('article[data-id]');
    if (!card) return;
    const id = parseInt(card.getAttribute('data-id') || '0', 10);
    const post = postsById.get(id);
    if (post) openReviewModal(post);
  });

  load();
</script>
