---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="관리자 - 고객 후기" headerOpaque hideFooter>
  <div class="mx-auto max-w-4xl px-4 pt-[calc(5.5rem+env(safe-area-inset-top,0px))] pb-8 sm:px-6 sm:pt-24 sm:pb-12">
    <div class="mb-6 flex flex-col gap-4 sm:mb-8 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-xl font-bold sm:text-2xl">관리자 - 고객 후기 관리</h1>
      <div class="flex flex-wrap items-center gap-3">
        <div id="bulk-actions" class="hidden items-center gap-3">
          <label class="flex cursor-pointer items-center gap-2 text-sm text-gray-600">
            <input type="checkbox" id="select-all" class="rounded border-gray-300" />
            전체 선택
          </label>
          <button type="button" id="bulk-approve-btn" class="cursor-pointer rounded bg-green-100 px-3 py-1.5 text-sm font-medium text-green-700 hover:bg-green-200 disabled:cursor-not-allowed disabled:opacity-50">
            선택 승인
          </button>
          <button type="button" id="bulk-delete-btn" class="cursor-pointer rounded bg-red-100 px-3 py-1.5 text-sm font-medium text-red-700 hover:bg-red-200 disabled:cursor-not-allowed disabled:opacity-50">
            선택 삭제
          </button>
        </div>
      </div>
    </div>

    <div id="posts-list" class="space-y-4">
      <p class="text-gray-500">로딩 중...</p>
    </div>
  </div>
</Layout>

<script>
  import { fetchPostsForAdmin, deletePost, updatePost, type Post } from '../../lib/api';

  const listEl = document.getElementById('posts-list')!;

  async function loadPosts() {
    try {
      const posts = await fetchPostsForAdmin();
      if (posts.length === 0) {
        listEl.innerHTML = '<p class="text-gray-500">등록된 고객 후기가 없습니다.</p>';
        const ba = document.getElementById('bulk-actions');
        if (ba) {
          ba.classList.add('hidden');
          ba.classList.remove('flex');
        }
        return;
      }
      const statusBadge = (s: string) => s === 'approved' ? '<span class="rounded bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">승인</span>' : '<span class="rounded bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800">대기</span>';
      listEl.innerHTML = posts
        .map(
          (p: Post) => `
        <article class="post-card flex cursor-pointer flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4 shadow-sm transition-shadow hover:shadow-md sm:flex-row sm:items-center sm:justify-between" data-id="${p.id}" role="button" tabindex="0">
          <div class="flex min-w-0 flex-1 cursor-pointer items-start gap-3">
            <input type="checkbox" class="post-checkbox mt-1 rounded border-gray-300" data-id="${p.id}" data-status="${p.status || ''}" aria-label="선택" />
            <div class="min-w-0 flex-1">
              <div class="flex flex-wrap items-center gap-2">
                <h3 class="truncate font-semibold">${escapeHtml(p.title)}</h3>
                ${p.status ? statusBadge(p.status) : ''}
              </div>
              <p class="mt-1 truncate text-sm text-gray-500">${escapeHtml(p.content?.slice(0, 50) || '-')}${(p.content?.length || 0) > 50 ? '...' : ''}</p>
              <p class="text-xs text-gray-400">${new Date(p.created_at).toLocaleDateString('ko-KR')}</p>
            </div>
          </div>
          <div class="flex shrink-0 flex-wrap gap-2 pl-7 sm:pl-0">
            ${p.status === 'pending' ? `<button data-id="${p.id}" class="approve-btn cursor-pointer rounded bg-green-100 px-3 py-1.5 text-sm text-green-700 hover:bg-green-200">승인</button>` : ''}
            ${p.status === 'approved' ? `<button data-id="${p.id}" class="revert-approve-btn cursor-pointer rounded bg-amber-100 px-3 py-1.5 text-sm text-amber-800 hover:bg-amber-200">승인 되돌리기</button>` : ''}
            <button data-id="${p.id}" class="delete-btn cursor-pointer rounded bg-red-100 px-3 py-1.5 text-sm text-red-700 hover:bg-red-200">삭제</button>
          </div>
        </article>
      `
        )
        .join('');

      listEl.querySelectorAll('.post-card').forEach((card) => {
        card.addEventListener('click', (e) => {
          if ((e.target as HTMLElement).closest('.post-checkbox, .approve-btn, .revert-approve-btn, .delete-btn')) return;
          const id = (card as HTMLElement).dataset.id;
          if (id) window.location.href = `/admin/post?id=${id}`;
        });
        card.addEventListener('keydown', (e) => {
          const ke = e as KeyboardEvent;
          if (ke.key === 'Enter' || ke.key === ' ') {
            e.preventDefault();
            if ((e.target as HTMLElement).closest('.post-checkbox, .approve-btn, .revert-approve-btn, .delete-btn')) return;
            const id = (card as HTMLElement).dataset.id;
            if (id) window.location.href = `/admin/post?id=${id}`;
          }
        });
      });

      const bulkActions = document.getElementById('bulk-actions')!;
      const selectAll = document.getElementById('select-all') as HTMLInputElement;
      const bulkApproveBtn = document.getElementById('bulk-approve-btn')!;
      const bulkDeleteBtn = document.getElementById('bulk-delete-btn')!;

      bulkActions.classList.remove('hidden');
      bulkActions.classList.add('flex');

      selectAll.checked = false;
      selectAll.addEventListener('change', () => {
        listEl.querySelectorAll<HTMLInputElement>('.post-checkbox').forEach((cb) => {
          cb.checked = selectAll.checked;
        });
      });

      listEl.querySelectorAll('.post-checkbox').forEach((cb) => {
        cb.addEventListener('change', () => {
          const all = listEl.querySelectorAll<HTMLInputElement>('.post-checkbox');
          const checked = listEl.querySelectorAll<HTMLInputElement>('.post-checkbox:checked');
          selectAll.checked = all.length > 0 && checked.length === all.length;
        });
      });

      bulkApproveBtn.addEventListener('click', async () => {
        const checked = listEl.querySelectorAll<HTMLInputElement>('.post-checkbox:checked');
        const pendingIds = Array.from(checked).filter((cb) => cb.dataset.status === 'pending').map((cb) => parseInt(cb.dataset.id!, 10));
        if (pendingIds.length === 0) {
          alert('승인할 후기를 선택해주세요. (대기 상태인 후기만 선택됩니다.)');
          return;
        }
        if (!confirm(`선택한 ${pendingIds.length}개의 후기를 승인하시겠습니까?`)) return;
        bulkApproveBtn.setAttribute('disabled', 'disabled');
        try {
          await Promise.all(pendingIds.map((id) => updatePost(id, { status: 'approved' })));
          loadPosts();
        } catch (e) {
          alert((e as Error).message);
        } finally {
          bulkApproveBtn.removeAttribute('disabled');
        }
      });

      bulkDeleteBtn.addEventListener('click', async () => {
        const checked = listEl.querySelectorAll<HTMLInputElement>('.post-checkbox:checked');
        const ids = Array.from(checked).map((cb) => parseInt(cb.dataset.id!, 10));
        if (ids.length === 0) {
          alert('삭제할 후기를 선택해주세요.');
          return;
        }
        if (!confirm(`선택한 ${ids.length}개의 후기를 삭제하시겠습니까?`)) return;
        bulkDeleteBtn.setAttribute('disabled', 'disabled');
        try {
          await Promise.all(ids.map((id) => deletePost(id)));
          loadPosts();
        } catch (e) {
          alert((e as Error).message);
        } finally {
          bulkDeleteBtn.removeAttribute('disabled');
        }
      });

      listEl.querySelectorAll('.approve-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm('정말 승인하시겠습니까?')) return;
          const id = parseInt((btn as HTMLButtonElement).dataset.id!, 10);
          (btn as HTMLButtonElement).setAttribute('disabled', 'disabled');
          try {
            await updatePost(id, { status: 'approved' });
            loadPosts();
          } catch (e) {
            alert((e as Error).message);
          }
        });
      });

      listEl.querySelectorAll('.revert-approve-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm('승인을 되돌리고 대기 상태로 변경하시겠습니까?')) return;
          const id = parseInt((btn as HTMLButtonElement).dataset.id!, 10);
          (btn as HTMLButtonElement).setAttribute('disabled', 'disabled');
          try {
            await updatePost(id, { status: 'pending' });
            loadPosts();
          } catch (e) {
            alert((e as Error).message);
          }
        });
      });

      listEl.querySelectorAll('.delete-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!confirm('정말 삭제하시겠습니까?')) return;
          const id = parseInt((btn as HTMLButtonElement).dataset.id!, 10);
          try {
            await deletePost(id);
            loadPosts();
          } catch (e) {
            alert((e as Error).message);
          }
        });
      });
    } catch (e) {
      listEl.innerHTML = `<p class="text-red-600">오류: ${(e as Error).message}</p>`;
    }
  }

  function escapeHtml(s: string) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  loadPosts();
</script>
