---
import '../styles/global.css';

interface Props {
  title?: string;
  /** true면 상단이 밝은 페이지(고객후기 등)에서 헤더를 처음부터 진한 스타일로 표시 */
  headerOpaque?: boolean;
  /** true면 푸터 영역 숨김 (관리자 페이지 등) */
  hideFooter?: boolean;
}

const { title = '올라포토 | 실전 카메라 리뷰 & 촬영 가이드', headerOpaque = false, hideFooter = false } = Astro.props;
---
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" crossorigin="anonymous" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <slot name="head" />
  </head>
  <body class="flex min-h-screen w-full min-w-0 flex-col overflow-x-hidden bg-[#F8FAFC] text-[#111827] antialiased pb-[var(--lecture-bar-height)]" data-header-opaque={headerOpaque}>
    <header id="main-header" class:list={[headerOpaque ? 'header-scrolled' : 'header-transparent', 'fixed top-0 left-0 right-0 z-50 transition-all duration-300']}>
      <nav class="relative mx-auto flex max-w-6xl items-center justify-between px-4 py-4 sm:px-6">
        <a href="/" class="flex items-center gap-2">
          <img src="/logo.png" alt="올라포토" class="h-9 w-9 sm:h-10 sm:w-10 header-logo rounded-full object-cover" />
          <span class="text-xl font-bold text-white sm:text-2xl header-logo-text" aria-label="올라포토">올라포토</span>
        </a>
        <button
          type="button"
          id="nav-toggle"
          class="header-toggle inline-flex cursor-pointer items-center justify-center rounded-lg p-2 text-white hover:bg-white/10 md:hidden"
          aria-label="메뉴 열기"
          aria-expanded="false"
        >
          <svg id="nav-icon-menu" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <svg id="nav-icon-close" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <ul id="nav-menu" class="nav-menu hidden md:static md:mt-0 md:flex md:flex-row md:gap-8 md:border-0 md:bg-transparent md:py-0 md:shadow-none">
          <li><a href="/#youtube-long" class="nav-link-premium nav-link-mobile">영상 리뷰</a></li>
          <li><a href="/#blog" class="nav-link-premium nav-link-mobile">장비 분석</a></li>
          <li><a href="/#youtube-shorts" class="nav-link-premium nav-link-mobile">Shorts</a></li>
          <li><a href="/#blog" class="nav-link-premium nav-link-mobile">블로그</a></li>
          <li><a href="/#about" class="nav-link-premium nav-link-mobile">협업 문의</a></li>
          <li><a href="https://blog.naver.com/PostList.naver?blogId=holaphotograph&from=postList&categoryNo=202" target="_blank" rel="noopener noreferrer" class="nav-link-premium nav-link-mobile">고객 후기</a></li>
          <li><a href="/#lecture" class="nav-link-premium nav-link-mobile text-slate-400">강의 (예정)</a></li>
        </ul>
      </nav>
    </header>
    <div id="nav-backdrop" class="nav-backdrop fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden md:hidden" aria-hidden="true"></div>
    <script>
      const header = document.getElementById('main-header');
      const toggle = document.getElementById('nav-toggle');
      const menu = document.getElementById('nav-menu');

      function updateHeader() {
        const opaque = document.body.dataset.headerOpaque === 'true';
        if (window.scrollY > 50 || opaque) {
          header?.classList.remove('header-transparent');
          header?.classList.add('header-scrolled');
        } else {
          header?.classList.remove('header-scrolled');
          header?.classList.add('header-transparent');
        }
      }
      window.addEventListener('scroll', updateHeader, { passive: true });
      updateHeader();

      const backdrop = document.getElementById('nav-backdrop');
      const iconMenu = document.getElementById('nav-icon-menu');
      const iconClose = document.getElementById('nav-icon-close');

      function setMenuOpen(open: boolean) {
        const isOpen = open && (window.innerWidth < 768);
        menu?.classList.toggle('hidden', !isOpen);
        menu?.classList.toggle('flex', isOpen);
        backdrop?.classList.toggle('hidden', !isOpen);
        document.body.classList.toggle('nav-open', isOpen);
        toggle?.setAttribute('aria-label', isOpen ? '메뉴 닫기' : '메뉴 열기');
        toggle?.setAttribute('aria-expanded', String(isOpen));
        iconMenu?.classList.toggle('hidden', isOpen);
        iconClose?.classList.toggle('hidden', !isOpen);
      }

      toggle?.addEventListener('click', () => {
        const isOpen = menu?.classList.contains('flex') && window.innerWidth < 768;
        setMenuOpen(!isOpen);
      });
      backdrop?.addEventListener('click', () => setMenuOpen(false));
      document.querySelectorAll('#nav-menu a').forEach((a) => {
        a.addEventListener('click', () => { if (window.innerWidth < 768) setMenuOpen(false); });
      });
    </script>
    <main class="flex-1 w-full min-w-0">
      <slot />
    </main>
    <!-- 강의 소식 플로팅 CTA (토글 가능) -->
    <aside id="lecture" class="fixed bottom-0 left-0 right-0 z-40 flex min-h-[var(--lecture-bar-mobile)] flex-col items-center justify-center border-t border-slate-700/50 bg-[#0E172A]/95 backdrop-blur-sm px-4 pt-6 pb-[calc(1rem+env(safe-area-inset-bottom,0px))] shadow-[0_-4px_20px_rgba(0,0,0,0.3)] transition-[min-height] duration-300 sm:min-h-[var(--lecture-bar-base)] sm:px-6 sm:pt-4 sm:pb-[calc(0.75rem+env(safe-area-inset-bottom,0px))]">
      <!-- 접기 탭: 플로팅 바 상단 경계에 하단이 딱 붙음 (bottom: 100%), CTA 오른쪽에 맞춤 -->
      <button type="button" id="lecture-bar-collapse" class="lecture-bar-content lecture-bar-tab-stick absolute bottom-full right-4 z-10 flex h-9 min-h-9 cursor-pointer items-center justify-center gap-1.5 rounded-t-lg border border-b-0 border-slate-700/50 bg-[#0E172A]/95 px-3 py-2 text-xs font-medium leading-none text-slate-400 shadow-[0_-2px_10px_rgba(0,0,0,0.2)] backdrop-blur-sm transition-colors hover:bg-slate-700/50 hover:text-white sm:right-6" aria-label="플로팅 바 접기">
        <svg class="h-4 w-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M5 9l7 7 7-7" /></svg>
        <span>접기</span>
      </button>
      <div class="lecture-bar-content mx-auto flex w-full max-w-4xl flex-1 flex-col items-stretch justify-center gap-3 sm:flex-row sm:items-center sm:justify-between sm:gap-4">
        <div class="flex flex-1 flex-col gap-3 sm:flex-row sm:items-center sm:justify-between sm:gap-4">
          <div class="text-center sm:text-left">
            <p class="font-semibold text-white">카메라 입문 & 실전 강의 준비 중</p>
            <p class="text-sm text-slate-400">기초부터 실전 촬영까지 단계별 강의 오픈 예정</p>
          </div>
          <div class="flex w-full flex-col gap-2 sm:w-[28rem] sm:flex-shrink-0">
            <form id="lecture-signup-form" class="flex w-full flex-col gap-2 sm:w-full sm:flex-row">
              <input
                type="email"
                name="email"
                id="lecture-email"
                placeholder="이메일 주소"
                required
                autocomplete="email"
                class="w-full rounded-lg border border-slate-600 bg-slate-800/50 px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:border-[#E11D48] focus:outline-none focus:ring-2 focus:ring-[#E11D48]/30 sm:flex-1 sm:min-w-0"
              />
              <button
                type="submit"
                id="lecture-signup-btn"
                class="w-full shrink-0 cursor-pointer rounded-lg bg-[#E11D48] px-6 py-2.5 text-sm font-semibold text-white transition-all hover:bg-[#be123c] focus:outline-none focus:ring-2 focus:ring-[#E11D48]/50 disabled:cursor-not-allowed disabled:opacity-70 sm:w-auto"
              >
                강의 소식 받기
              </button>
            </form>
            <p id="lecture-signup-status" class="min-h-6 text-center text-sm sm:text-left" aria-live="polite" role="status"></p>
          </div>
        </div>
      </div>
      <!-- 펼치기 탭: 접었을 때 플로팅 바 상단 경계에 하단이 딱 붙음 (접기 탭과 동일 방식) -->
      <button type="button" id="lecture-bar-expand" class="lecture-bar-tab absolute bottom-full right-4 z-10 flex h-9 min-h-9 cursor-pointer items-center justify-center gap-1.5 rounded-t-lg border border-b-0 border-slate-700/50 bg-[#0E172A]/95 px-3 py-2 text-xs font-medium leading-none text-slate-400 shadow-[0_-2px_10px_rgba(0,0,0,0.2)] backdrop-blur-sm transition-colors hover:bg-slate-700/50 hover:text-white sm:right-6" aria-label="강의 소식 바 펼치기">
        <svg class="h-4 w-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M5 15l7-7 7 7" /></svg>
        <span>열기</span>
      </button>
    </aside>
    <script>
      (function lectureBarToggle() {
        const STORAGE_KEY = 'lecture-bar-collapsed';
        const bar = document.getElementById('lecture');
        const collapseBtn = document.getElementById('lecture-bar-collapse');
        const expandBtn = document.getElementById('lecture-bar-expand');

        function isCollapsed() { return document.body.classList.contains('lecture-bar-collapsed'); }
        function setCollapsed(collapsed: boolean) {
          document.body.classList.toggle('lecture-bar-collapsed', collapsed);
          try { sessionStorage.setItem(STORAGE_KEY, collapsed ? '1' : '0'); } catch (_) {}
        }

        /* 최초 상태는 항상 플로팅 바 펼침(복원하지 않음) */
        collapseBtn?.addEventListener('click', () => setCollapsed(true));
        expandBtn?.addEventListener('click', () => setCollapsed(false));
      })();

      // 강의 소식 수신 신청 폼 (모든 페이지에서 동작)
      (function initLectureSignup() {
        const form = document.getElementById('lecture-signup-form') as HTMLFormElement | null;
        const input = document.getElementById('lecture-email') as HTMLInputElement | null;
        const btn = document.getElementById('lecture-signup-btn') as HTMLButtonElement | null;
        const status = document.getElementById('lecture-signup-status') as HTMLElement | null;
        if (!form || !input || !btn || !status) return;

        const isProd = typeof window !== 'undefined' && !window.location.hostname.includes('localhost');
        const API_BASE = isProd ? 'https://holaphotograph-api.chs4413.workers.dev' : 'http://localhost:8787';

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = input.value.trim();
          if (!email) {
            status.textContent = '이메일을 입력해주세요.';
            status.className = 'min-h-6 text-center text-sm sm:text-left text-amber-400';
            return;
          }
          btn.disabled = true;
          status.textContent = '등록 중…';
          status.className = 'min-h-6 text-center text-sm sm:text-left text-slate-400';
          try {
            const res = await fetch(`${API_BASE}/api/lecture-signup`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: email.toLowerCase() }),
            });
            const data = (await res.json().catch(() => ({}))) as { message?: string; error?: string };
            if (res.ok) {
              status.textContent = '✓ ' + (data.message || '등록되었습니다.');
              status.className = 'min-h-6 text-center text-sm sm:text-left text-emerald-400 font-medium';
              input.value = '';
            } else {
              status.textContent = '✗ ' + (data.error || '등록에 실패했습니다. 다시 시도해주세요.');
              status.className = 'min-h-6 text-center text-sm sm:text-left text-amber-400';
            }
          } catch (_) {
            status.textContent = '✗ 네트워크 오류. 다시 시도해주세요.';
            status.className = 'min-h-6 text-center text-sm sm:text-left text-amber-400';
          } finally {
            btn.disabled = false;
          }
        });
      })();
    </script>

    {!hideFooter && (
    <footer class="border-t border-slate-700/50 bg-[#0F172A] py-14 sm:py-20">
      <div class="mx-auto max-w-6xl px-4 sm:px-6">
        <div class="text-center">
          <p class="text-xl font-semibold text-white sm:text-2xl">
            장비 선택부터 촬영까지, 실전 기반 가이드.
          </p>
          <div class="mt-6 flex justify-center gap-8">
            <a href="https://youtube.com/channel/UCsD5VP6TvRMt-sq0q25HlIA?themeRefresh=1" target="_blank" rel="noopener noreferrer" class="footer-channel-icon" aria-label="유튜브">
              <img src="/icons/youtube.svg" alt="" class="h-8 w-8 sm:h-9 sm:w-9" aria-hidden="true" />
            </a>
            <a href="https://blog.naver.com/holaphotograph" target="_blank" rel="noopener noreferrer" class="footer-channel-icon group relative inline-flex" aria-label="네이버 블로그">
              <img src="/icons/naver-blog.svg" alt="" class="h-8 w-8 sm:h-9 sm:w-9 block transition-opacity duration-250 group-hover:opacity-0" aria-hidden="true" />
              <img src="/icons/naver-blog-hover.svg" alt="" class="absolute inset-0 m-auto h-8 w-8 sm:h-9 sm:w-9 opacity-0 transition-opacity duration-250 group-hover:opacity-100" aria-hidden="true" />
            </a>
            <a href="https://www.instagram.com/snap.hola" target="_blank" rel="noopener noreferrer" class="footer-channel-icon" aria-label="인스타그램">
              <img src="/icons/instagram.svg" alt="" class="h-8 w-8 sm:h-9 sm:w-9" aria-hidden="true" />
            </a>
            <a href="mailto:holaphotographer@gmail.com" class="footer-channel-icon" aria-label="문의하기">
              <img src="/icons/contact.svg" alt="" class="h-8 w-8 sm:h-9 sm:w-9" aria-hidden="true" />
            </a>
          </div>
        </div>
        <p class="mt-10 text-center text-sm text-slate-500">© {new Date().getFullYear()} 올라포토. All rights reserved.</p>
      </div>
    </footer>
    )}
  </body>
</html>
